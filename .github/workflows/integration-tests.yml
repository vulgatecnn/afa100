name: å‰åç«¯é›†æˆæµ‹è¯•æµæ°´çº¿

on:
  push:
    branches: [main, develop]
    paths:
      - 'afa-office-system/**'
      - 'shared/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'afa-office-system/**'
      - 'shared/**'
      - '.github/workflows/integration-tests.yml'
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'æµ‹è¯•èŒƒå›´'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - backend-only
          - frontend-only
          - integration-only
          - e2e-only
      browser_matrix:
        description: 'æµè§ˆå™¨æµ‹è¯•çŸ©é˜µ'
        required: false
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - safari
          - edge
          - all
      coverage_threshold:
        description: 'è¦†ç›–ç‡é˜ˆå€¼'
        required: false
        default: '80'
        type: string

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '8'
  MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD || 'test_password' }}
  MYSQL_DATABASE: 'afa_office_test'
  MYSQL_USER: 'afa_test'
  MYSQL_PASSWORD: ${{ secrets.MYSQL_TEST_PASSWORD || 'test_password' }}

jobs:
  # ç¯å¢ƒå‡†å¤‡å’Œä¾èµ–å®‰è£…
  setup:
    name: ç¯å¢ƒå‡†å¤‡
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-keys.outputs.cache-key }}
      test-scope: ${{ steps.test-scope.outputs.scope }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ç”Ÿæˆç¼“å­˜é”®
        id: cache-keys
        run: |
          echo "cache-key=${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            afa-office-system/backend/node_modules
            afa-office-system/frontend/tenant-admin/node_modules
            afa-office-system/frontend/merchant-admin/node_modules
          key: ${{ steps.cache-keys.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: ç¡®å®šæµ‹è¯•èŒƒå›´
        id: test-scope
        run: |
          if [ "${{ github.event.inputs.test_scope }}" != "" ]; then
            echo "scope=${{ github.event.inputs.test_scope }}" >> $GITHUB_OUTPUT
          else
            echo "scope=all" >> $GITHUB_OUTPUT
          fi

  # åç«¯å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
  backend-tests:
    name: åç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.test-scope == 'all' || needs.setup.outputs.test-scope == 'backend-only' || needs.setup.outputs.test-scope == 'integration-only'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
          MYSQL_ALLOW_EMPTY_PASSWORD: 'no'
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            afa-office-system/backend/node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: ç­‰å¾…MySQLå°±ç»ª
        run: |
          echo "ç­‰å¾… MySQL æœåŠ¡å¯åŠ¨..."
          for i in {1..60}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -p${{ env.MYSQL_ROOT_PASSWORD }} --silent 2>/dev/null; then
              echo "MySQL æœåŠ¡å·²å°±ç»ª (å°è¯• $i æ¬¡)"
              break
            fi
            echo "ç­‰å¾… MySQL å¯åŠ¨... ($i/60)"
            sleep 3
          done
          
          echo "éªŒè¯ MySQL è¿æ¥..."
          mysql -h 127.0.0.1 -P 3306 -u root -p${{ env.MYSQL_ROOT_PASSWORD }} -e "SELECT VERSION();" || {
            echo "MySQL è¿æ¥éªŒè¯å¤±è´¥"
            exit 1
          }

      - name: åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
        working-directory: afa-office-system/backend
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
        run: |
          cp .env.test .env
          echo "æµ‹è¯• MySQL è¿æ¥..."
          mysql -h 127.0.0.1 -u root -p${{ env.MYSQL_ROOT_PASSWORD }} -e "SELECT 1;" || echo "MySQL è¿æ¥å¤±è´¥"
          echo "åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œç”¨æˆ·..."
          mysql -h 127.0.0.1 -u root -p${{ env.MYSQL_ROOT_PASSWORD }} -e "
            CREATE DATABASE IF NOT EXISTS ${{ env.MYSQL_DATABASE }};
            CREATE USER IF NOT EXISTS '${{ env.MYSQL_USER }}'@'%' IDENTIFIED BY '${{ env.MYSQL_PASSWORD }}';
            GRANT ALL PRIVILEGES ON ${{ env.MYSQL_DATABASE }}.* TO '${{ env.MYSQL_USER }}'@'%';
            FLUSH PRIVILEGES;
          " || echo "æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨è„šæœ¬..."
          pnpm db:integration:init || echo "è„šæœ¬åˆå§‹åŒ–å¤±è´¥ï¼Œç»§ç»­æµ‹è¯•..."

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        working-directory: afa-office-system/backend
        continue-on-error: true
        run: |
          echo "::group::ESLintæ£€æŸ¥"
          pnpm lint || echo "ESLintæ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
          echo "::endgroup::"
          
          echo "::group::TypeScriptç±»å‹æ£€æŸ¥"
          pnpm type-check || echo "TypeScriptç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
          echo "::endgroup::"
          
          echo "::group::ç±»å‹æ£€æŸ¥éªŒè¯"
          if [ -f "scripts/type-check-validation.js" ]; then
            pnpm type-check:validate || echo "ç±»å‹æ£€æŸ¥éªŒè¯å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
          fi
          echo "::endgroup::"

      - name: æ„å»ºåç«¯
        working-directory: afa-office-system/backend
        run: pnpm build

      - name: è¿è¡Œåç«¯å•å…ƒæµ‹è¯•
        working-directory: afa-office-system/backend
        run: |
          echo "::group::å•å…ƒæµ‹è¯•"
          pnpm test --reporter=verbose
          echo "::endgroup::"

      - name: è¿è¡Œåç«¯é›†æˆæµ‹è¯•
        working-directory: afa-office-system/backend
        run: |
          echo "::group::é›†æˆæµ‹è¯•"
          pnpm test:verification --reporter=verbose
          echo "::endgroup::"

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
        working-directory: afa-office-system/backend
        run: |
          echo "::group::è¦†ç›–ç‡æµ‹è¯•"
          pnpm test:coverage --reporter=verbose
          echo "::endgroup::"

      - name: ä¸Šä¼ åç«¯æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: |
            afa-office-system/backend/coverage/
            afa-office-system/backend/test-results/
          retention-days: 30

  # å‰ç«¯æµ‹è¯•
  frontend-tests:
    name: å‰ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.test-scope == 'all' || needs.setup.outputs.test-scope == 'frontend-only'
    
    strategy:
      matrix:
        frontend: [tenant-admin, merchant-admin]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            afa-office-system/frontend/${{ matrix.frontend }}/node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: å®‰è£…å‰ç«¯é¡¹ç›®ä¾èµ–
        working-directory: afa-office-system/frontend/${{ matrix.frontend }}
        run: |
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ£€æŸ¥ package.json æ–‡ä»¶:"
          ls -la package.json || echo "package.json ä¸å­˜åœ¨"
          echo "æ¸…ç†å¯èƒ½çš„ç¼“å­˜..."
          rm -rf node_modules package-lock.json || true
          echo "å®‰è£…ä¾èµ–..."
          pnpm install --no-frozen-lockfile
          echo "æ£€æŸ¥å…³é”®ä¾èµ–:"
          ls -la node_modules/@typescript-eslint/ || echo "@typescript-eslint ä¾èµ–æœªå®‰è£…"
          ls -la node_modules/eslint/ || echo "eslint ä¾èµ–æœªå®‰è£…"

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        working-directory: afa-office-system/frontend/${{ matrix.frontend }}
        continue-on-error: true
        run: |
          if [ -f "package.json" ] && grep -q "lint" package.json; then
            echo "::group::ESLintæ£€æŸ¥"
            pnpm lint || echo "ESLint æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
            echo "::endgroup::"
          fi
          
          if [ -f "package.json" ] && grep -q "type-check" package.json; then
            echo "::group::TypeScriptç±»å‹æ£€æŸ¥"
            pnpm type-check || echo "TypeScript æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
            echo "::endgroup::"
          fi

      - name: æ„å»ºå‰ç«¯
        working-directory: afa-office-system/frontend/${{ matrix.frontend }}
        run: |
          if [ -f "package.json" ] && grep -q "build" package.json; then
            pnpm build
          fi

      - name: è¿è¡Œå‰ç«¯å•å…ƒæµ‹è¯•
        working-directory: afa-office-system/frontend/${{ matrix.frontend }}
        run: |
          if [ -f "package.json" ] && grep -q "test" package.json; then
            echo "::group::å‰ç«¯å•å…ƒæµ‹è¯•"
            pnpm test --run --reporter=verbose
            echo "::endgroup::"
          fi

      - name: ä¸Šä¼ å‰ç«¯æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-${{ matrix.frontend }}-test-reports
          path: |
            afa-office-system/frontend/${{ matrix.frontend }}/coverage/
            afa-office-system/frontend/${{ matrix.frontend }}/test-results/
          retention-days: 30

  # ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
  e2e-integration-tests:
    name: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [setup, backend-tests]
    if: needs.setup.outputs.test-scope == 'all' || needs.setup.outputs.test-scope == 'integration-only' || needs.setup.outputs.test-scope == 'e2e-only'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    strategy:
      matrix:
        browser: [chromium, firefox]
        include:
          - browser: webkit
            if: runner.os == 'macOS'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            afa-office-system/backend/node_modules
            afa-office-system/frontend/tenant-admin/node_modules
            afa-office-system/frontend/merchant-admin/node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: å®‰è£…Playwrightæµè§ˆå™¨
        working-directory: afa-office-system/backend
        run: npx playwright install ${{ matrix.browser }}

      - name: ç­‰å¾…MySQLå°±ç»ª
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -p${{ env.MYSQL_ROOT_PASSWORD }} --silent; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        working-directory: afa-office-system/backend
        run: |
          cp .env.e2e .env
          pnpm db:integration:init

      - name: æ„å»ºåº”ç”¨
        run: |
          cd afa-office-system/backend && pnpm build
          if [ -d "afa-office-system/frontend/tenant-admin" ]; then
            cd afa-office-system/frontend/tenant-admin && pnpm build
          fi
          if [ -d "afa-office-system/frontend/merchant-admin" ]; then
            cd afa-office-system/frontend/merchant-admin && pnpm build
          fi

      - name: å¯åŠ¨åç«¯æœåŠ¡
        working-directory: afa-office-system/backend
        run: |
          pnpm start &
          echo $! > backend.pid
          
          # ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨
          for i in {1..30}; do
            if curl -f http://localhost:5100/api/v1/health > /dev/null 2>&1; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: è¿è¡Œç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
        working-directory: afa-office-system/backend
        run: |
          echo "::group::E2Eé›†æˆæµ‹è¯• - ${{ matrix.browser }}"
          BROWSER=${{ matrix.browser }} pnpm test:e2e --reporter=html
          echo "::endgroup::"

      - name: è¿è¡Œä¸šåŠ¡æµç¨‹æµ‹è¯•
        working-directory: afa-office-system/backend
        run: |
          echo "::group::ä¸šåŠ¡æµç¨‹æµ‹è¯• - ${{ matrix.browser }}"
          BROWSER=${{ matrix.browser }} pnpm test:e2e:business
          echo "::endgroup::"

      - name: åœæ­¢åç«¯æœåŠ¡
        if: always()
        working-directory: afa-office-system/backend
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
            rm backend.pid
          fi

      - name: ä¸Šä¼ E2Eæµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-reports-${{ matrix.browser }}
          path: |
            afa-office-system/backend/tests/e2e/reports/
            afa-office-system/backend/test-results/
          retention-days: 30

      - name: ä¸Šä¼ æµ‹è¯•æˆªå›¾
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots-${{ matrix.browser }}
          path: |
            afa-office-system/backend/tests/e2e/screenshots/
            afa-office-system/backend/test-results/
          retention-days: 7

  # è·¨æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
  cross-browser-tests:
    name: è·¨æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [setup, e2e-integration-tests]
    if: (needs.setup.outputs.test-scope == 'all' || needs.setup.outputs.test-scope == 'e2e-only') && (github.event.inputs.browser_matrix == 'all' || github.event_name == 'schedule')
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            afa-office-system/backend/node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      - name: å®‰è£…æ‰€æœ‰æµè§ˆå™¨
        working-directory: afa-office-system/backend
        run: npx playwright install

      - name: åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        working-directory: afa-office-system/backend
        run: |
          cp .env.e2e .env
          pnpm db:integration:init

      - name: æ„å»ºåº”ç”¨
        working-directory: afa-office-system/backend
        run: pnpm build

      - name: å¯åŠ¨åç«¯æœåŠ¡
        working-directory: afa-office-system/backend
        run: |
          pnpm start &
          echo $! > backend.pid
          
          # ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨
          for i in {1..30}; do
            if curl -f http://localhost:5100/api/v1/health > /dev/null 2>&1; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: è¿è¡Œè·¨æµè§ˆå™¨æµ‹è¯•
        working-directory: afa-office-system/backend
        run: |
          echo "::group::è·¨æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•"
          pnpm test:e2e:cross-browser --reporter=html
          echo "::endgroup::"

      - name: åœæ­¢åç«¯æœåŠ¡
        if: always()
        working-directory: afa-office-system/backend
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
            rm backend.pid
          fi

      - name: ä¸Šä¼ è·¨æµè§ˆå™¨æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cross-browser-test-reports
          path: |
            afa-office-system/backend/tests/e2e/reports/cross-browser-report/
          retention-days: 30

  # æµ‹è¯•ç»“æœæ±‡æ€»å’ŒæŠ¥å‘Š
  test-summary:
    name: æµ‹è¯•ç»“æœæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-integration-tests]
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          path: test-reports

      - name: ç”Ÿæˆæµ‹è¯•æ±‡æ€»æŠ¥å‘Š
        run: |
          echo "# å‰åç«¯é›†æˆæµ‹è¯•æ±‡æ€»æŠ¥å‘Š" > test-summary.md
          echo "" >> test-summary.md
          echo "## æµ‹è¯•æ‰§è¡Œæ—¶é—´" >> test-summary.md
          echo "- å¼€å§‹æ—¶é—´: ${{ github.event.head_commit.timestamp }}" >> test-summary.md
          echo "- ç»“æŸæ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> test-summary.md
          echo "" >> test-summary.md
          
          echo "## æµ‹è¯•ç»“æœæ¦‚è§ˆ" >> test-summary.md
          echo "| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | è¯¦æƒ… |" >> test-summary.md
          echo "|---------|------|------|" >> test-summary.md
          echo "| åç«¯æµ‹è¯• | ${{ needs.backend-tests.result }} | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• |" >> test-summary.md
          echo "| å‰ç«¯æµ‹è¯• | ${{ needs.frontend-tests.result }} | ç»„ä»¶æµ‹è¯• + å•å…ƒæµ‹è¯• |" >> test-summary.md
          echo "| E2Eé›†æˆæµ‹è¯• | ${{ needs.e2e-integration-tests.result }} | ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹æµ‹è¯• |" >> test-summary.md
          echo "" >> test-summary.md
          
          echo "## è¦†ç›–ç‡ç»Ÿè®¡" >> test-summary.md
          if [ -d "test-reports/backend-test-reports/coverage" ]; then
            echo "### åç«¯è¦†ç›–ç‡" >> test-summary.md
            if [ -f "test-reports/backend-test-reports/coverage/coverage-summary.json" ]; then
              echo "è¯¦ç»†è¦†ç›–ç‡æ•°æ®è¯·æŸ¥çœ‹é™„ä»¶ä¸­çš„coverageæŠ¥å‘Š" >> test-summary.md
            fi
          fi
          echo "" >> test-summary.md
          
          echo "## æµ‹è¯•ç¯å¢ƒä¿¡æ¯" >> test-summary.md
          echo "- Node.jsç‰ˆæœ¬: ${{ env.NODE_VERSION }}" >> test-summary.md
          echo "- pnpmç‰ˆæœ¬: ${{ env.PNPM_VERSION }}" >> test-summary.md
          echo "- è¿è¡Œç¯å¢ƒ: ${{ runner.os }}" >> test-summary.md
          echo "- è§¦å‘äº‹ä»¶: ${{ github.event_name }}" >> test-summary.md
          echo "- åˆ†æ”¯: ${{ github.ref_name }}" >> test-summary.md
          echo "- æäº¤: ${{ github.sha }}" >> test-summary.md

      - name: ä¸Šä¼ æµ‹è¯•æ±‡æ€»æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-report
          path: |
            test-summary.md
            test-reports/
          retention-days: 90

      - name: æ£€æŸ¥æµ‹è¯•ç»“æœ
        run: |
          echo "æ£€æŸ¥æµ‹è¯•ç»“æœ..."
          
          # æ£€æŸ¥å…³é”®æµ‹è¯•æ˜¯å¦é€šè¿‡
          if [ "${{ needs.backend-tests.result }}" != "success" ]; then
            echo "âŒ åç«¯æµ‹è¯•å¤±è´¥"
            exit 1
          fi
          
          if [ "${{ needs.e2e-integration-tests.result }}" != "success" ]; then
            echo "âŒ E2Eé›†æˆæµ‹è¯•å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰å…³é”®æµ‹è¯•é€šè¿‡"

  # é€šçŸ¥å’Œåç»­å¤„ç†
  notification:
    name: æµ‹è¯•ç»“æœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [test-summary]
    if: always()
    
    steps:
      - name: æµ‹è¯•ç»“æœé€šçŸ¥
        run: |
          if [ "${{ needs.test-summary.result }}" == "success" ]; then
            echo "âœ… å‰åç«¯é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡"
            echo "ğŸ‰ ç³»ç»Ÿé›†æˆæµ‹è¯•éªŒè¯æˆåŠŸ"
          else
            echo "âŒ å‰åç«¯é›†æˆæµ‹è¯•å­˜åœ¨å¤±è´¥"
            echo "ğŸ” è¯·æ£€æŸ¥æµ‹è¯•æŠ¥å‘Šäº†è§£è¯¦ç»†ä¿¡æ¯"
            exit 1
          fi

      - name: è®¾ç½®æµ‹è¯•çŠ¶æ€
        if: always()
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œæ¯”å¦‚å‘é€åˆ°Slackã€é’‰é’‰ç­‰
          echo "æµ‹è¯•å®Œæˆï¼ŒçŠ¶æ€: ${{ needs.test-summary.result }}"
