<!--å‘˜å·¥ç”³è¯·é¡µé¢-->
<view class="container">
  <view class="header">
    <text class="title">å‘˜å·¥ç”³è¯·</text>
    <text class="subtitle">ç”³è¯·æˆä¸ºæ­£å¼å‘˜å·¥ï¼Œè·å¾—é•¿æœŸé€šè¡Œæƒé™</text>
  </view>

  <!-- ç”³è¯·çŠ¶æ€æ˜¾ç¤º -->
  <view class="status-section" wx:if="{{existingApplication}}">
    <view class="status-card status-{{existingApplication.status}}">
      <view class="status-header">
        <text class="status-title">ç”³è¯·çŠ¶æ€</text>
        <view class="status-badge status-{{existingApplication.status}}">
          {{statusText[existingApplication.status]}}
        </view>
      </view>
      
      <view class="status-content">
        <view class="info-row">
          <text class="label">ç”³è¯·å•†æˆ·ï¼š</text>
          <text class="value">{{existingApplication.merchantName}}</text>
        </view>
        <view class="info-row">
          <text class="label">ç”³è¯·å§“åï¼š</text>
          <text class="value">{{existingApplication.name}}</text>
        </view>
        <view class="info-row">
          <text class="label">ç”³è¯·æ—¶é—´ï¼š</text>
          <text class="value">{{existingApplication.createdAtText}}</text>
        </view>
        <view class="info-row" wx:if="{{existingApplication.approvedAt}}">
          <text class="label">å®¡æ‰¹æ—¶é—´ï¼š</text>
          <text class="value">{{existingApplication.approvedAtText}}</text>
        </view>
        <view class="info-row" wx:if="{{existingApplication.status === 'rejected' && existingApplication.reason}}">
          <text class="label">æ‹’ç»åŸå› ï¼š</text>
          <text class="value reason-text">{{existingApplication.reason}}</text>
        </view>
      </view>
      
      <view class="status-actions">
        <button 
          class="btn-passcode" 
          wx:if="{{existingApplication.status === 'approved'}}"
          bindtap="onViewEmployeePasscode"
        >
          æŸ¥çœ‹å‘˜å·¥é€šè¡Œç 
        </button>
        <button 
          class="btn-reapply" 
          wx:if="{{existingApplication.status === 'rejected'}}"
          bindtap="onReapply"
        >
          é‡æ–°ç”³è¯·
        </button>
        <button 
          class="btn-withdraw" 
          wx:if="{{existingApplication.status === 'pending'}}"
          bindtap="onWithdrawApplication"
        >
          æ’¤é”€ç”³è¯·
        </button>
      </view>
    </view>
  </view>

  <!-- ç”³è¯·è¡¨å• -->
  <form bindsubmit="onSubmit" bindreset="onReset" wx:if="{{!existingApplication || showReapplyForm}}">
    <view class="form-section">
      <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
      
      <view class="form-item">
        <text class="label">å§“å *</text>
        <input 
          class="input {{formErrors.name ? 'input-error' : ''}}" 
          name="name"
          value="{{formData.name}}"
          placeholder="è¯·è¾“å…¥çœŸå®å§“å"
          bindinput="onInputChange"
          data-field="name"
          maxlength="20"
        />
        <text class="error-text" wx:if="{{formErrors.name}}">{{formErrors.name}}</text>
      </view>

      <view class="form-item">
        <text class="label">æ‰‹æœºå· *</text>
        <input 
          class="input {{formErrors.phone ? 'input-error' : ''}}" 
          name="phone"
          value="{{formData.phone}}"
          placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·"
          type="number"
          bindinput="onInputChange"
          data-field="phone"
          maxlength="11"
        />
        <text class="error-text" wx:if="{{formErrors.phone}}">{{formErrors.phone}}</text>
      </view>

      <view class="form-item">
        <text class="label">èº«ä»½è¯å·</text>
        <input 
          class="input {{formErrors.idCard ? 'input-error' : ''}}" 
          name="idCard"
          value="{{formData.idCard}}"
          placeholder="è¯·è¾“å…¥18ä½èº«ä»½è¯å·ï¼ˆå¯é€‰ï¼‰"
          bindinput="onInputChange"
          data-field="idCard"
          maxlength="18"
        />
        <text class="error-text" wx:if="{{formErrors.idCard}}">{{formErrors.idCard}}</text>
      </view>

      <view class="form-item">
        <text class="label">é‚®ç®±åœ°å€</text>
        <input 
          class="input {{formErrors.email ? 'input-error' : ''}}" 
          name="email"
          value="{{formData.email}}"
          placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€ï¼ˆå¯é€‰ï¼‰"
          bindinput="onInputChange"
          data-field="email"
        />
        <text class="error-text" wx:if="{{formErrors.email}}">{{formErrors.email}}</text>
      </view>
    </view>

    <view class="form-section">
      <view class="section-title">å·¥ä½œä¿¡æ¯</view>
      
      <view class="form-item">
        <text class="label">ç”³è¯·å•†æˆ· *</text>
        <picker 
          mode="selector" 
          range="{{merchants}}" 
          range-key="name"
          value="{{merchantIndex}}"
          bindchange="onMerchantChange"
          class="{{formErrors.merchantId ? 'picker-error' : ''}}"
        >
          <view class="picker {{!selectedMerchant ? 'picker-placeholder' : ''}}">
            {{selectedMerchant ? selectedMerchant.name : 'è¯·é€‰æ‹©è¦åŠ å…¥çš„å•†æˆ·'}}
          </view>
        </picker>
        <text class="error-text" wx:if="{{formErrors.merchantId}}">{{formErrors.merchantId}}</text>
        
        <!-- å•†æˆ·ä¿¡æ¯å±•ç¤º -->
        <view class="merchant-info" wx:if="{{selectedMerchant}}">
          <view class="merchant-detail">
            <text class="detail-label">è”ç³»äººï¼š</text>
            <text class="detail-value">{{selectedMerchant.contact}}</text>
          </view>
          <view class="merchant-detail">
            <text class="detail-label">è”ç³»ç”µè¯ï¼š</text>
            <text class="detail-value">{{selectedMerchant.phone}}</text>
          </view>
        </view>
      </view>

      <view class="form-item">
        <text class="label">éƒ¨é—¨ *</text>
        <input 
          class="input {{formErrors.department ? 'input-error' : ''}}" 
          name="department"
          value="{{formData.department}}"
          placeholder="è¯·è¾“å…¥æ‰€å±éƒ¨é—¨"
          bindinput="onInputChange"
          data-field="department"
          maxlength="30"
        />
        <text class="error-text" wx:if="{{formErrors.department}}">{{formErrors.department}}</text>
      </view>

      <view class="form-item">
        <text class="label">èŒä½ *</text>
        <input 
          class="input {{formErrors.position ? 'input-error' : ''}}" 
          name="position"
          value="{{formData.position}}"
          placeholder="è¯·è¾“å…¥èŒä½åç§°"
          bindinput="onInputChange"
          data-field="position"
          maxlength="30"
        />
        <text class="error-text" wx:if="{{formErrors.position}}">{{formErrors.position}}</text>
      </view>

      <view class="form-item">
        <text class="label">å…¥èŒæ—¥æœŸ</text>
        <picker 
          mode="date" 
          value="{{formData.startDate}}"
          bindchange="onDateChange"
          data-field="startDate"
        >
          <view class="picker">
            {{formData.startDate || 'è¯·é€‰æ‹©é¢„æœŸå…¥èŒæ—¥æœŸï¼ˆå¯é€‰ï¼‰'}}
          </view>
        </picker>
      </view>
    </view>

    <view class="form-section">
      <view class="section-title">ç´§æ€¥è”ç³»äºº</view>
      
      <view class="form-item">
        <text class="label">è”ç³»äººå§“å</text>
        <input 
          class="input {{formErrors.emergencyContact ? 'input-error' : ''}}" 
          name="emergencyContact"
          value="{{formData.emergencyContact}}"
          placeholder="è¯·è¾“å…¥ç´§æ€¥è”ç³»äººå§“åï¼ˆå¯é€‰ï¼‰"
          bindinput="onInputChange"
          data-field="emergencyContact"
          maxlength="20"
        />
        <text class="error-text" wx:if="{{formErrors.emergencyContact}}">{{formErrors.emergencyContact}}</text>
      </view>

      <view class="form-item">
        <text class="label">è”ç³»äººç”µè¯</text>
        <input 
          class="input {{formErrors.emergencyPhone ? 'input-error' : ''}}" 
          name="emergencyPhone"
          value="{{formData.emergencyPhone}}"
          placeholder="è¯·è¾“å…¥ç´§æ€¥è”ç³»äººç”µè¯ï¼ˆå¯é€‰ï¼‰"
          type="number"
          bindinput="onInputChange"
          data-field="emergencyPhone"
          maxlength="11"
        />
        <text class="error-text" wx:if="{{formErrors.emergencyPhone}}">{{formErrors.emergencyPhone}}</text>
      </view>

      <view class="form-item">
        <text class="label">ä¸è”ç³»äººå…³ç³»</text>
        <picker 
          mode="selector" 
          range="{{relationshipOptions}}" 
          value="{{relationshipIndex}}"
          bindchange="onRelationshipChange"
        >
          <view class="picker">
            {{formData.emergencyRelationship || 'è¯·é€‰æ‹©å…³ç³»ï¼ˆå¯é€‰ï¼‰'}}
          </view>
        </picker>
      </view>
    </view>

    <!-- èº«ä»½éªŒè¯æç¤º -->
    <view class="verification-section" wx:if="{{!existingApplication}}">
      <view class="section-title">èº«ä»½éªŒè¯</view>
      <view class="verification-notice">
        <view class="notice-icon">ğŸ”’</view>
        <view class="notice-content">
          <text class="notice-title">å®åè®¤è¯</text>
          <text class="notice-desc">ä¸ºç¡®ä¿å®‰å…¨ï¼Œæ‚¨çš„ç”³è¯·å°†ä¸å¾®ä¿¡å®åä¿¡æ¯è¿›è¡ŒéªŒè¯</text>
        </view>
      </view>
    </view>

    <view class="button-group">
      <button class="btn-reset" form-type="reset" wx:if="{{!showReapplyForm}}">é‡ç½®</button>
      <button 
        class="btn-cancel" 
        bindtap="onCancelReapply" 
        wx:if="{{showReapplyForm}}"
      >
        å–æ¶ˆ
      </button>
      <button class="btn-submit" form-type="submit" loading="{{submitting}}">
        {{submitting ? 'æäº¤ä¸­...' : (showReapplyForm ? 'é‡æ–°æäº¤' : 'æäº¤ç”³è¯·')}}
      </button>
    </view>
  </form>

  <!-- ç”³è¯·é¡»çŸ¥ -->
  <view class="notice-section">
    <view class="section-title">ç”³è¯·é¡»çŸ¥</view>
    <view class="notice-list">
      <view class="notice-item">
        <text class="number">1</text>
        <text class="text">è¯·ç¡®ä¿å¡«å†™ä¿¡æ¯çœŸå®æœ‰æ•ˆ</text>
      </view>
      <view class="notice-item">
        <text class="number">2</text>
        <text class="text">ç”³è¯·æäº¤åéœ€è¦å•†æˆ·ç®¡ç†å‘˜å®¡æ‰¹</text>
      </view>
      <view class="notice-item">
        <text class="number">3</text>
        <text class="text">å®¡æ‰¹é€šè¿‡åå°†è·å¾—é•¿æœŸé€šè¡Œæƒé™</text>
      </view>
      <view class="notice-item">
        <text class="number">4</text>
        <text class="text">å¦‚æœ‰ç–‘é—®è¯·è”ç³»ç›®æ ‡å•†æˆ·HRæˆ–ç®¡ç†å‘˜</text>
      </view>
    </view>
  </view>
</view>

<!-- åŠ è½½æç¤º -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-content">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>