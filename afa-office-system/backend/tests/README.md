# AFA办公小程序通行系统测试文档

## 测试概述

本文档描述了AFA办公小程序通行系统的完整测试套件，涵盖了通行码生成、验证、通行记录管理等核心功能的各种场景和边界条件测试。

## 测试结构

```
tests/
├── unit/                           # 单元测试
│   ├── services/                   # 服务层测试
│   │   ├── passcode.service.test.ts        # 通行码服务测试
│   │   └── access-record.service.test.ts   # 通行记录服务测试
│   └── utils/                      # 工具类测试
│       └── qrcode.test.ts          # 二维码工具测试
├── integration/                    # 集成测试
│   ├── access.test.ts              # 原有通行系统集成测试
│   └── access-system.test.ts       # 完整通行系统集成测试
├── performance/                    # 性能测试
│   └── access-performance.test.ts  # 通行系统性能测试
├── security/                       # 安全测试
│   └── access-security.test.ts     # 通行系统安全测试
├── helpers/                        # 测试辅助工具
│   ├── database-mock.ts            # 数据库Mock
│   └── test-data-factory.ts        # 测试数据工厂
├── fixtures/                       # 测试数据
│   └── test-data.json              # 静态测试数据
└── setup.ts                        # 测试环境配置
```

## 测试覆盖范围

### 1. 通行码生成测试 (passcode.service.test.ts)

#### 核心功能测试
- ✅ 员工通行码生成
- ✅ 访客通行码生成
- ✅ 动态二维码通行码生成
- ✅ 时效性通行码生成
- ✅ 批量通行码生成

#### 边界条件测试
- ✅ 用户不存在的处理
- ✅ 权限合并逻辑
- ✅ 自定义选项处理
- ✅ 极端过期时间处理
- ✅ 使用次数限制处理

#### 验证功能测试
- ✅ 有效通行码验证
- ✅ 无效通行码拒绝
- ✅ 过期通行码处理
- ✅ 使用次数限制验证
- ✅ 用户状态检查
- ✅ 二维码验证
- ✅ 时效性通行码验证

#### 管理功能测试
- ✅ 通行码刷新
- ✅ 通行码信息查询
- ✅ 统计信息获取
- ✅ 过期通行码清理

### 2. 通行记录测试 (access-record.service.test.ts)

#### 记录管理测试
- ✅ 成功通行记录
- ✅ 失败通行记录
- ✅ 批量记录创建
- ✅ 记录查询和筛选
- ✅ 分页查询

#### 统计功能测试
- ✅ 通行统计信息
- ✅ 实时状态监控
- ✅ 设备状态检测
- ✅ 用户通行历史

#### 数据完整性测试
- ✅ 必需字段验证
- ✅ 枚举值验证
- ✅ 时间戳格式验证
- ✅ 数据清理功能

### 3. 二维码工具测试 (qrcode.test.ts)

#### 加密解密测试
- ✅ 二维码内容生成
- ✅ 二维码内容解析
- ✅ 加密数据完整性
- ✅ 防篡改验证

#### 时效性功能测试
- ✅ 时效性通行码生成
- ✅ 时效性通行码验证
- ✅ 时间窗口容错处理
- ✅ 过期检测

#### 安全功能测试
- ✅ 防重放攻击nonce
- ✅ 强加密算法使用
- ✅ 随机数生成质量
- ✅ 校验码生成验证

### 4. 系统集成测试 (access-system.test.ts)

#### 完整流程测试
- ✅ 员工通行完整生命周期
- ✅ 访客通行完整流程
- ✅ 二维码通行验证
- ✅ 时效性通行码验证

#### 权限安全测试
- ✅ 禁用用户拒绝
- ✅ 过期通行码拒绝
- ✅ 使用次数限制
- ✅ 并发验证处理

#### 记录查询测试
- ✅ 通行记录查询
- ✅ 用户筛选
- ✅ 设备筛选
- ✅ 结果筛选
- ✅ 日期范围查询
- ✅ 统计信息获取

#### 实时监控测试
- ✅ 设备实时状态
- ✅ 离线设备检测
- ✅ 通行码管理

### 5. 性能测试 (access-performance.test.ts)

#### 通行码性能测试
- ✅ 大量通行码生成性能
- ✅ 高并发生成唯一性保证
- ✅ 动态二维码生成效率
- ✅ 通行码验证速度

#### 通行记录性能测试
- ✅ 大量通行日志记录
- ✅ 批量记录操作效率
- ✅ 大数据量查询性能
- ✅ 复杂条件查询优化

#### 工具性能测试
- ✅ 二维码生成解析速度
- ✅ 时效性通行码处理效率
- ✅ 唯一ID生成性能
- ✅ 加密解密性能

#### 资源管理测试
- ✅ 内存使用监控
- ✅ 数据库连接池管理
- ✅ 资源清理验证
- ✅ 高负载稳定性

### 6. 安全测试 (access-security.test.ts)

#### 认证授权安全
- ✅ 无效JWT token拒绝
- ✅ 过期token处理
- ✅ 篡改token检测
- ✅ 权限提升防护
- ✅ 跨用户数据访问防护

#### 通行码安全
- ✅ 暴力破解防护
- ✅ 重放攻击防护
- ✅ 枚举攻击防护
- ✅ 随机性和唯一性保证

#### 二维码安全
- ✅ 内容篡改防护
- ✅ 重放攻击防护
- ✅ 时间操纵防护
- ✅ 强加密保护

#### 输入验证安全
- ✅ SQL注入防护
- ✅ XSS攻击防护
- ✅ 输入长度限制
- ✅ 字符集验证

#### DoS防护测试
- ✅ 大量并发请求处理
- ✅ 恶意大请求体处理
- ✅ 速率限制验证

#### 数据安全测试
- ✅ 敏感信息泄露防护
- ✅ 错误消息安全
- ✅ 日志记录安全
- ✅ 加密哈希强度

## 测试执行

### 运行所有测试
```bash
pnpm test
```

### 运行特定测试套件
```bash
# 单元测试
pnpm test tests/unit/

# 集成测试
pnpm test tests/integration/

# 性能测试
pnpm test tests/performance/

# 安全测试
pnpm test tests/security/
```

### 运行特定测试文件
```bash
# 通行码服务测试
pnpm test tests/unit/services/passcode.service.test.ts

# 通行记录服务测试
pnpm test tests/unit/services/access-record.service.test.ts

# 二维码工具测试
pnpm test tests/unit/utils/qrcode.test.ts

# 完整系统集成测试
pnpm test tests/integration/access-system.test.ts

# 性能测试
pnpm test tests/performance/access-performance.test.ts

# 安全测试
pnpm test tests/security/access-security.test.ts
```

### 测试覆盖率
```bash
pnpm test:coverage
```

## 测试数据

### 测试数据工厂 (TestDataFactory)
提供创建各种测试数据的便捷方法：
- `createMerchant()` - 创建测试商户
- `createUser()` - 创建测试用户
- `createProject()` - 创建测试项目
- `createVenue()` - 创建测试场地
- `createFloor()` - 创建测试楼层
- `createVisitorApplication()` - 创建测试访客申请
- `createAccessRecord()` - 创建测试通行记录

### Mock配置
- 数据库操作Mock
- 外部服务Mock
- 时间Mock (用于时效性测试)
- 加密工具Mock

## 测试环境

### 数据库
- 使用内存SQLite数据库进行测试
- 每个测试前自动清理数据
- 测试结束后关闭连接

### 配置
- 测试专用配置文件
- 环境变量隔离
- Mock外部依赖

## 性能基准

### 通行码操作
- 单个通行码生成: < 50ms
- 批量通行码生成(50个): < 5s
- 通行码验证: < 10ms
- 二维码生成: < 20ms

### 通行记录操作
- 单条记录创建: < 10ms
- 批量记录创建(100条): < 3s
- 记录查询(分页): < 1s
- 统计查询: < 2s

### 并发性能
- 并发通行码验证(100个): < 3s
- 并发记录创建(200个): < 8s
- 高负载测试(500个操作): < 60s

## 安全基准

### 认证安全
- JWT token验证: 100% 拒绝无效token
- 权限检查: 100% 防止越权访问
- 会话管理: 正确处理过期和刷新

### 数据安全
- 输入验证: 100% 拒绝恶意输入
- SQL注入防护: 100% 防护率
- XSS防护: 100% 输出转义

### 通行码安全
- 随机性: 通过统计测试
- 唯一性: 100% 保证
- 防重放: 时间窗口和nonce保护

## 测试报告

测试执行后会生成详细的测试报告，包括：
- 测试通过率
- 代码覆盖率
- 性能指标
- 安全检查结果
- 失败测试详情

## 持续集成

测试套件集成到CI/CD流程中：
- 代码提交时自动运行单元测试
- 合并请求时运行完整测试套件
- 发布前运行性能和安全测试
- 定期运行压力测试

## 测试维护

### 添加新测试
1. 确定测试类型和位置
2. 使用现有的测试模式
3. 添加必要的Mock配置
4. 更新测试文档

### 测试数据管理
1. 使用TestDataFactory创建测试数据
2. 保持测试数据的一致性
3. 及时清理测试数据
4. 避免测试间的数据污染

### 性能监控
1. 定期检查测试执行时间
2. 监控性能基准变化
3. 优化慢速测试
4. 更新性能目标

## 故障排除

### 常见问题
1. **Mock配置错误**: 检查Mock的返回值和调用次数
2. **数据库连接问题**: 确保测试数据库正确初始化
3. **异步测试问题**: 正确使用async/await
4. **时间相关测试**: 使用vi.useFakeTimers()

### 调试技巧
1. 使用console.log输出调试信息
2. 检查Mock调用历史
3. 验证测试数据状态
4. 使用断点调试

## 总结

本测试套件全面覆盖了AFA办公小程序通行系统的各个方面，包括：

- **功能完整性**: 覆盖所有核心业务功能
- **边界条件**: 测试各种异常和边界情况
- **性能保证**: 验证系统在高负载下的表现
- **安全防护**: 确保系统抵御各种安全威胁
- **数据完整性**: 保证数据的准确性和一致性

通过这套完整的测试体系，我们可以确保通行系统的可靠性、安全性和性能，为用户提供稳定的服务体验。