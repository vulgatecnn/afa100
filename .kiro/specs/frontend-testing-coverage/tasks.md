# AFA 办公小程序全栈测试覆盖率规范实施计划

## 实施任务列表

### 覆盖率目标说明

本项目目标是实现 80%以上的代码覆盖率，具体要求：

- **后端模块**: 控制器、服务、模型、中间件均需达到 80%覆盖率（branches, functions, lines, statements）
- **前端模块**: 组件、服务、Hook、工具函数均需达到 80%覆盖率
- **小程序模块**: 页面、组件、服务、工具函数均需达到 80%覆盖率
- **整体项目**: 三个模块的综合覆盖率需达到 80%以上

### 测试驱动开发流程说明

**重要**：本 spec 不仅仅是编写测试用例，而是完整的测试驱动开发流程：

1. **编写测试用例** - 为现有代码编写全面的单元测试、集成测试
2. **发现问题** - 通过测试发现代码中的 bug、设计缺陷、业务逻辑错误
3. **修复 bug** - 修复测试中暴露的所有问题，包括：
   - API 接口设计不一致
   - 业务逻辑错误
   - 错误处理不完善
   - 数据验证缺失
   - 安全性漏洞
4. **完善代码质量** - 统一代码风格、优化性能、改进用户体验
5. **验证覆盖率** - 确保每个模块达到 80%覆盖率目标

每个任务完成后都需要验证相应模块的覆盖率是否达标，未达标的需要补充测试用例。

- [x] 1. 修复后端测试环境配置问题

  - **当前问题**: 后端测试全部失败，主要是数据库连接和配置问题
  - 修复 MySQL 测试数据库连接配置，解决 "数据库连接池未初始化" 错误
  - 简化测试环境设置，移除复杂的增强测试框架，使用基础的 MySQL 连接
  - 修复测试 setup 文件中的数据库初始化逻辑
  - 确保测试可以正常运行并生成覆盖率报告
  - _需求: 1.1, 1.2_

- [x] 2. 修复前端测试环境问题



  - **当前问题**: 前端测试大量失败，主要是 userEvent.setup() 和测试库版本兼容性问题
  - 升级或修复 @testing-library/user-event 版本兼容性问题
  - 修复测试中的 Mock 设置和组件渲染问题
  - 解决 MSW 和 API 模拟的配置问题
  - 确保前端测试可以正常运行并生成覆盖率报告
  - _需求: 2.1, 2.2_


- [x] 3. 修复小程序测试环境问题


  - **当前问题**: 小程序测试大量失败，主要是微信 API 模拟和组件上下文问题
  - 完善微信 API 的模拟实现，包括 wx.showActionSheet、wx.createCanvasContext 等
  - 修复小程序组件测试中的 this.properties、this.data、this.setData 等上下文问题
  - 改进小程序页面和组件的测试辅助工具
  - 修复验证工具函数的实现，确保边界条件处理正确
  - 确保小程序测试可以正常运行并生成覆盖率报告
  - _需求: 3.1, 3.2_



- [ ] 4. 实现后端单元测试修复和覆盖率达标

  - **当前状态**: 后端测试基础设施已建立，但需要修复配置问题
  - 修复数据库连接和测试环境初始化问题
  - 简化测试配置，移除过度复杂的增强测试框架
  - 确保所有控制器、服务、模型、中间件测试正常运行
  - **验证后端模块整体覆盖率达到 80%以上**
  - _需求: 1.1, 1.3, 1.4, 1.5_

- [ ] 5. 实现前端组件单元测试修复和覆盖率达标

  - **当前状态**: 前端测试已部分实现，但需要修复测试库兼容性问题
  - 修复 userEvent 和 testing-library 版本兼容性
  - 完善组件测试的 Mock 和渲染逻辑
  - 补充缺失的组件和服务测试用例
  - **验证前端模块整体覆盖率达到 80%以上**
  - _需求: 2.1, 2.3_

- [ ] 6. 实现小程序单元测试修复和覆盖率达标

  - **当前状态**: 小程序测试框架已建立，但需要修复模拟和上下文问题
  - 完善微信 API 模拟和小程序环境模拟
  - 修复组件和页面测试的上下文问题
  - 改进工具函数的实现和测试
  - **验证小程序模块整体覆盖率达到 80%以上**
  - _需求: 3.1, 3.3, 3.4_

- [ ] 7. 验证全栈单元测试 80%覆盖率达标

  - 运行修复后的全栈测试套件，生成后端、前端、小程序的覆盖率报告
  - 检查每个模块是否达到 80%覆盖率阈值（branches, functions, lines, statements）
  - 识别覆盖率不足的具体代码区域和未测试的分支
  - 补充缺失的单元测试用例，重点覆盖未测试的代码路径
  - 确保项目整体单元测试覆盖率达到 80%以上
  - _需求: 1.2, 2.2, 3.2_

- [ ] 8. 建立后端集成测试体系（可选）

  - **当前状态**: 后端已有大量集成测试，但需要修复配置问题后才能运行
  - 实现 API 端点的完整功能测试
  - 测试数据库操作的正确性和事务处理
  - 验证认证和权限控制的完整流程
  - _需求: 4.1, 4.2, 4.3, 4.4_

- [ ] 9. 建立前端集成测试体系（可选）

  - **当前状态**: 前端已有部分集成测试，但需要修复基础单元测试后再考虑
  - 实现页面级集成测试
  - 测试组件间的数据流和交互
  - 验证路由导航和状态管理
  - _需求: 5.1, 5.2, 5.4, 5.5_

- [ ] 10. 建立小程序集成测试体系（可选）

  - **当前状态**: 小程序已有部分集成测试，但需要修复基础单元测试后再考虑
  - 实现小程序页面间的数据传递测试
  - 测试小程序业务流程的完整性
  - 验证小程序与后端 API 的集成
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [ ] 11. 实现全栈 E2E 测试覆盖（可选）

  - **当前状态**: E2E 测试是最高级别的测试，需要在单元测试达标后再考虑
  - 使用 Playwright 编写前端端到端测试
  - 使用微信开发工具进行小程序 E2E 测试
  - 验证跨平台数据一致性和用户体验
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [ ] 12. 建立全栈测试监控和报告系统（可选）

  - **当前状态**: 监控系统可以在基础测试达标后建立
  - 实现全栈测试覆盖率监控
  - 生成详细的测试报告
  - 建立测试性能监控
  - _需求: 9.3, 10.1, 10.3_

- [ ] 13. 配置全栈 CI/CD 集成和自动化（可选）

  - **当前状态**: CI/CD 集成可以在测试稳定后配置
  - 配置 GitHub Actions 自动运行全栈测试
  - 建立测试失败时的阻断机制
  - 实现测试报告的自动发布
  - _需求: 9.1, 9.2, 9.4, 9.6_
