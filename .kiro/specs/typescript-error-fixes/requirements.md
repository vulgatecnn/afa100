# TypeScript 错误修复需求文档

## 介绍

AFA办公系统后端项目当前存在大量 TypeScript 类型错误，需要系统性地修复这些错误以确保代码质量和类型安全。通过分析错误日志，我们发现主要有三类核心问题需要解决。

## 修复原则和约束

**重要约束:**
- **禁止使用脚本批量修复** - 所有修复必须手动进行，确保每个修改都经过仔细审查
- **阶段性检查** - 每完成一个需求的修复后，必须运行类型检查验证修复效果
- **回退机制** - 如果修复过程中出现新问题或使情况变得更糟，立即回退到上一个稳定状态
- **逐步修复** - 按优先级顺序修复，避免同时处理多个问题导致混乱
- **验证驱动** - 每次修复后都要验证是否真正解决了目标问题，而不是引入新问题

## 需求

### 需求 1: 修复类型导入错误

**用户故事:** 作为开发者，我希望所有必要的类型定义都能正确导入，以便控制器和服务层能够正常使用类型检查。

#### 验收标准

1. WHEN 控制器文件导入 API 类型 THEN 系统应该能找到所有必要的类型定义
2. WHEN 编译器检查类型导入 THEN 不应该出现 "Module has no exported member" 错误
3. WHEN 开发者使用 AsyncControllerMethod、LoginRequest 等类型 THEN 这些类型应该可用且正确定义

### 需求 2: 清理测试代码混入问题

**用户故事:** 作为开发者，我希望生产代码中不包含测试相关的类型和代码，以确保代码的清洁性和正确性。

#### 验收标准

1. WHEN 编译器检查生产代码 THEN 不应该出现 MockedFunction 相关的类型错误
2. WHEN 生产代码运行 THEN 不应该包含任何测试框架的依赖
3. WHEN 开发者查看控制器代码 THEN 应该只看到生产环境相关的代码

### 需求 3: 修复 exactOptionalPropertyTypes 兼容性

**用户故事:** 作为开发者，我希望可选属性的类型定义与 TypeScript 严格模式兼容，以确保类型安全。

#### 验收标准

1. WHEN 使用可选属性赋值 undefined THEN 类型系统应该正确处理 undefined 与 null 的区别
2. WHEN 创建 API 数据对象 THEN passcodeId、userId 等字段的类型应该与接口定义匹配
3. WHEN 编译器进行类型检查 THEN 不应该出现 "Type 'undefined' is not assignable to type 'number | null'" 错误

### 需求 4: 修复环境变量类型安全

**用户故事:** 作为开发者，我希望环境变量的类型处理是安全的，避免 undefined 值导致的运行时错误。

#### 验收标准

1. WHEN 读取环境变量 THEN 系统应该提供合理的默认值
2. WHEN 环境变量未定义 THEN 不应该将 undefined 赋值给 string 类型
3. WHEN 配置管理器初始化 THEN 所有必需的配置项都应该有有效值

### 需求 5: 完整性验证和质量保证

**用户故事:** 作为开发者，我希望修复完成后能够确认所有 TypeScript 错误都已解决，且没有引入新的问题。

#### 验收标准

1. WHEN 所有修复完成后运行 `pnpm type-check` THEN 应该没有任何 TypeScript 错误
2. WHEN 修复过程中出现新错误 THEN 应该立即停止并分析原因
3. WHEN 单个需求修复完成 THEN 必须验证该需求相关的错误已完全消除
4. WHEN 发现修复导致更多问题 THEN 必须回退到修复前的状态
5. WHEN 最终验证 THEN 错误数量应该从当前的数百个减少到零个