# AFA 办公小程序 MVP 实施计划

- [x] 1. 项目初始化和基础架构搭建

  - 创建项目目录结构，初始化 package.json 和基础配置文件
  - 配置开发环境，包括 ESLint、Prettier、Vitest 等工具
  - 设置数据库连接和基础中间件
  - _需求: 6.1, 6.2_

- [x] 1.1 创建后端项目结构

  - 初始化 Node.js 项目，安装 Express、SQLite 等核心依赖
  - 创建标准的 MVC 目录结构 (controllers, services, models, routes 等)
  - 配置开发工具链 (ESLint, Prettier, Vitest)
  - _需求: 6.1, 6.2_

- [x] 1.2 配置数据库和基础中间件

  - 设置 SQLite 数据库连接和配置
  - 实现基础中间件 (CORS, JSON 解析, 错误处理, 日志记录)
  - 创建数据库初始化脚本和迁移系统
  - _需求: 6.1, 6.2_

- [x] 1.3 编写项目初始化测试

  - 创建测试环境配置和测试数据库
  - 编写基础中间件的单元测试
  - 设置测试覆盖率报告
  - _需求: 6.1, 6.2_

- [x] 2. 数据模型和数据库结构实现

  - 创建所有核心数据表的 SQL 结构定义
  - 实现数据模型类和基础 CRUD 操作
  - 建立表之间的关联关系和约束
  - _需求: 1.2, 2.3, 3.1, 4.1, 5.4, 6.5_

- [x] 2.1 创建用户和商户相关数据表

  - 实现 users 表结构，包含微信授权字段和用户类型
  - 实现 merchants 表结构，包含商户信息和权限配置
  - 创建数据表索引和外键约束
  - _需求: 1.2, 2.3_

- [x] 2.2 创建空间管理相关数据表

  - 实现 projects、venues、floors 表的层级结构
  - 实现 permissions 表用于权限管理
  - 建立空间与权限的关联关系
  - _需求: 1.6, 6.5_

- [x] 2.3 创建访客和通行相关数据表

  - 实现 visitor_applications 表存储访客申请信息
  - 实现 passcodes 表存储通行码信息
  - 实现 access_records 表记录通行日志
  - _需求: 3.1, 3.4, 5.1, 5.4_

- [x] 2.4 编写数据模型测试

  - 为每个数据模型编写 CRUD 操作测试
  - 测试数据验证和约束条件
  - 测试表关联关系的完整性
  - _需求: 1.2, 2.3, 3.1, 5.4_

- [x] 3. 认证授权系统实现

  - 实现 JWT token 生成和验证机制
  - 集成微信 OAuth 登录流程
  - 实现 RBAC 权限控制中间件
  - _需求: 1.1, 2.1, 3.2, 4.2_

- [x] 3.1 实现 JWT 认证服务

  - 创建 JWT token 生成、验证和刷新功能
  - 实现认证中间件拦截未授权请求
  - 处理 token 过期和刷新逻辑
  - _需求: 1.1, 2.1, 3.2, 4.2_

- [x] 3.2 集成微信 OAuth 登录

  - 实现微信授权登录接口，获取用户 openId 和基本信息
  - 处理新用户注册和老用户登录逻辑
  - 实现用户身份类型选择 (访客/员工)
  - _需求: 3.2, 4.2_

- [x] 3.3 实现权限控制系统

  - 创建 RBAC 权限验证中间件
  - 实现用户权限检查和资源访问控制
  - 建立角色和权限的动态分配机制
  - _需求: 1.6, 2.4_

- [x] 3.4 编写认证授权测试

  - 测试 JWT token 的生成、验证和刷新
  - 测试微信登录流程和用户创建
  - 测试权限控制中间件的各种场景
  - _需求: 1.1, 2.1, 3.2, 4.2_

- [x] 4. 租务管理功能实现

  - 实现商户管理的增删改查接口
  - 实现空间管理和权限分配功能
  - 创建租务管理员的操作界面后端支持
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [x] 4.1 实现商户管理接口

  - 创建商户 CRUD 操作的控制器和服务
  - 实现商户启用/停用功能，自动处理员工权限
  - 实现商户权限分配和管理功能
  - _需求: 1.1, 1.2, 1.6_

- [x] 4.2 实现空间管理接口

  - 创建项目、场地、楼层的层级管理接口
  - 实现空间信息的增删改查操作
  - 建立空间与商户权限的关联管理
  - _需求: 1.5, 1.6_

- [x] 4.3 编写租务管理功能测试

  - 测试商户管理的各种操作场景
  - 测试空间管理的层级关系处理
  - 测试权限分配的正确性和安全性
  - _需求: 1.1, 1.2, 1.5, 1.6_

- [x] 5. 商户管理功能实现

  - 实现员工管理的增删改查和批量导入
  - 实现访客申请的审批流程
  - 创建商户管理员的操作权限控制
  - _需求: 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 5.1 实现员工管理接口

  - 创建员工增删改查接口，支持单个和批量操作
  - 实现 Excel 批量导入功能，包含数据验证
  - 实现员工权限分配和角色管理
  - _需求: 2.2, 2.4_

- [x] 5.2 实现访客审批接口

  - 创建访客申请列表查询和详情查看接口
  - 实现访客申请的审批/拒绝功能
  - 实现通行码生成和发送通知机制
  - _需求: 2.5, 2.6_

- [x] 5.3 编写商户管理功能测试

  - 测试员工管理的各种操作和权限控制
  - 测试批量导入的数据验证和错误处理
  - 测试访客审批流程的完整性
  - _需求: 2.2, 2.4, 2.5, 2.6_

- [x] 6. 修复后端单元测试问题


  - 修复现有单元测试中的失败用例（98 个失败测试）
  - 优化代码质量和错误处理机制
  - 完善 TypeScript 类型定义和接口规范
  - _需求: 所有需求的质量保证_

- [x] 6.1 修复认证和权限单元测试

  - 修复 auth.middleware.test.ts 中的 JWT payload 结构不匹配问题
  - 修复 auth.test.ts 中微信登录 Mock 配置和响应格式问题
  - 完善权限检查逻辑和测试用例覆盖
  - _需求: 1.1, 2.1, 3.2, 4.2_

- [x] 6.2 修复数据模型单元测试

  - 修复模型创建后查询失败的问题 (create 方法返回值处理)
  - 修复外键约束和数据验证逻辑
  - 完善测试数据的创建和清理机制
  - _需求: 1.2, 2.2, 2.4, 2.5_

- [x] 6.3 修复服务层单元测试

  - 修复 EmployeeService 构造函数中的 UserModel 实例化问题
  - 完善 Mock 数据和数据库连接的测试配置
  - 修复 AccessRecordService 中数据访问的空值处理
  - _需求: 1.2, 2.2, 2.4, 2.5_

- [x] 6.4 修复控制器单元测试

  - 修复 AccessController 测试中 Mock 响应对象的调用问题
  - 完善控制器的错误处理和响应格式
  - 修复 QRCode 工具类的测试断言方法
  - _需求: 所有需求的控制器层支持_

- [x] 7. 通行码生成和验证系统

  - 实现动态二维码生成算法
  - 创建通行码验证接口供硬件设备调用
  - 实现通行记录的存储和查询
  - _需求: 3.4, 3.5, 3.6, 4.3, 4.4, 5.1, 5.2, 5.3_

- [x] 7.1 实现通行码生成服务
- 创建动态二维码生成算法，包含时效性和使用次数控制
- 实现员工和访客不同类型的通行码生成逻辑
- 建立通行码与用户权限的关联验证
- _需求: 3.4, 4.3, 5.1, 5.2_

- [x] 7.2 实现通行验证接口

  - 创建硬件设备调用的通行码验证 API
  - 实现通行权限检查和设备权限验证
  - 处理通行成功/失败的响应和日志记录
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [x] 7.3 编写通行系统测试

  - 测试通行码生成的各种场景和边界条件
  - 测试通行验证接口的安全性和性能
  - 测试通行记录的准确性和完整性
  - _需求: 3.4, 4.3, 5.1, 5.2, 5.3_

- [x] 8. 访客小程序核心功能

  - 实现访客预约申请流程
  - 创建通行码展示和使用界面
  - 实现员工申请和审批功能
  - _需求: 3.1, 3.3, 3.4, 3.5, 4.1, 4.2, 4.4_

- [x] 8.1 实现访客预约功能

  - 创建访客预约申请表单和提交接口
  - 实现预约信息验证和商户匹配逻辑
  - 建立预约状态跟踪和通知机制
  - _需求: 3.1, 3.4, 3.5_

- [x] 8.2 完善员工申请功能

  - 完善新员工申请表单的页面实现
  - 优化员工身份验证和商户关联逻辑
  - 完善员工账号自动创建和审批流程
  - _需求: 4.1, 4.2_

- [x] 8.3 实现通行码展示功能

  - 创建实时通行码展示界面
  - 实现通行码的自动刷新和状态更新
  - 建立通行历史记录查询功能
  - _需求: 3.6, 4.4_

- [x] 8.4 编写小程序功能测试

  - 测试访客预约的完整流程
  - 测试员工申请和审批的各种场景
  - 测试通行码展示的实时性和准确性
  - _需求: 3.1, 3.4, 4.1, 4.4_

- [x] 9. 前端管理后台开发

  - 创建租务管理端的用户界面
  - 创建商户管理端的用户界面
  - 实现响应式设计和用户体验优化
  - _需求: 1.1, 1.5, 2.2, 2.5_

- [x] 9.1 开发租务管理前端

  - 创建商户管理页面，包含列表、新增、编辑功能
  - 创建空间管理页面，支持层级结构展示
  - 实现权限分配界面和操作流程
  - _需求: 1.1, 1.5, 1.6_

-

- [x] 9.2 完善商户管理前端功能

  - 完善员工管理页面的批量导入和权限设置功能
  - 完善访客管理页面的审批流程和记录查看
  - 实现数据可视化和统计报表功能
  - _需求: 2.2, 2.4, 2.5, 2.6_

- [-] 9.3 编写前端 E2E 测试

  - 使用 Playwright 进行前端端到端测试
  - 测试用户界面的交互和数据流
  - 测试响应式设计在不同设备上的表现
  - _需求: 1.1, 2.2, 2.5_

- [-] 10. 提升测试覆盖率到80%



  - 修复所有失败的单元测试（154个失败测试）
  - 补充缺失的服务层和中间件测试
  - 完善工具类和模型层的测试覆盖
  - 达到80%的代码覆盖率目标
  - _需求: 所有需求的质量保证_

- [x] 10.1 修复模型层测试失败问题



  - 修复"创建后查询失败"的根本问题（影响所有模型测试）
  - 优化数据库事务处理和测试数据隔离
  - 修复外键约束和数据完整性问题
  - 确保所有模型CRUD操作测试通过
  - _需求: 1.2, 2.2, 2.3, 2.4, 2.5_

- [x] 10.2 补充服务层单元测试



  - 为AuthService编写完整的单元测试（当前0%覆盖率）
  - 为EmployeeService编写单元测试（当前0%覆盖率）
  - 为MerchantService编写单元测试（当前0%覆盖率）
  - 为VisitorService编写单元测试（当前0%覆盖率）
  - 为NotificationService编写单元测试（当前0%覆盖率）
  - 提升PasscodeService测试覆盖率（从25.26%到80%+）
  - 提升AccessRecordService测试覆盖率（从42.05%到80%+）
  - _需求: 1.1, 2.1, 2.2, 2.4, 2.5, 3.2, 4.2_

- [x] 10.3 补充中间件单元测试



  - 为认证中间件编写完整测试（auth.middleware.ts，当前0%覆盖率）
  - 为权限中间件编写测试（permission.middleware.ts，当前0%覆盖率）
  - 为错误处理中间件编写测试（error.middleware.ts，当前0%覆盖率）
  - 为验证中间件编写测试（validation.middleware.ts，当前0%覆盖率）
  - 为安全中间件编写测试（security.middleware.ts，当前0%覆盖率）
  - 为限流中间件编写测试（rate-limit.middleware.ts，当前0%覆盖率）
  - _需求: 1.1, 2.1, 3.2, 4.2, 安全性需求_

- [ ] 10.4 补充控制器单元测试



  - 为AuthController编写完整测试（当前0%覆盖率）
  - 为EmployeeController编写测试（当前0%覆盖率）
  - 为MerchantController编写测试（当前0%覆盖率）
  - 为VisitorController编写测试（当前0%覆盖率）
  - 为SpaceController编写测试（当前0%覆盖率）
  - 为TenantController编写测试（当前0%覆盖率）
  - 为EmployeeApplicationController编写测试（当前0%覆盖率）
  - _需求: 1.1, 1.2, 2.2, 2.5, 3.1, 4.1, 4.2_

- [ ] 10.5 提升工具类测试覆盖率

  - 提升QRCode工具类测试覆盖率（从43.36%到80%+）
  - 提升数据库工具类测试覆盖率（从44.95%到80%+）
  - 为JWT工具类编写完整测试（当前0%覆盖率）
  - 为微信工具类编写测试（当前0%覆盖率）
  - _需求: 3.4, 3.5, 认证安全需求_

- [ ] 10.6 集成测试修复和补充

  - 修复认证集成测试失败问题（auth.test.ts中的8个失败测试）
  - 补充完整的API端到端测试
  - 测试业务流程的完整性和数据一致性
  - 验证系统各模块间的集成正确性
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [ ] 10.7 测试覆盖率验证和优化

  - 运行完整的测试覆盖率报告
  - 识别和补充覆盖率低于80%的代码区域
  - 优化测试用例的质量和有效性
  - 建立持续集成的覆盖率检查机制
  - _需求: 所有需求的质量保证_

- [ ] 11. 后端系统优化和部署准备

  - 完善开发环境配置和调试工具
  - 优化开发体验和代码质量
  - 准备生产环境部署配置
  - _需求: 5.1, 5.2, 5.3, 5.4, 6.1, 6.2_

- [ ] 11.1 开发环境优化
  - 完善开发环境的启动脚本和配置
  - 优化热重载和调试体验
  - 完善开发文档和使用说明
  - _需求: 6.1, 6.2_

- [ ] 11.2 生产环境准备
  - 配置生产环境的数据库和服务器设置
  - 实现日志记录和监控机制
  - 准备部署脚本和CI/CD流程
  - _需求: 6.1, 6.2, 安全性和性能需求_
